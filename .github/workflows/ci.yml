name: ci pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  ARTIFACT_NAME: A18_AdryanSerage_final_1288
  DOCKER_IMAGE_NAME: a18_adryanserrage_final_1288

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: récupération du code
      uses: actions/checkout@v4

    - name: configuration jdk 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: compilation application java
      run: |
        javac DockerDemo.java
        echo "compilation terminée"

    - name: exécution application java
      run: |
        java DockerDemo

    - name: configuration docker buildx
      uses: docker/setup-buildx-action@v2

    - name: construction image docker
      run: |
        docker build -t $DOCKER_IMAGE_NAME:$GITHUB_RUN_NUMBER .
        docker build -t $DOCKER_IMAGE_NAME:latest .
        echo "image docker construite avec succès"

    - name: test image docker
      run: |
        docker run --rm $DOCKER_IMAGE_NAME:$GITHUB_RUN_NUMBER

    - name: préparation des artifacts
      run: |
        mkdir -p artifacts
        cp DockerDemo.java artifacts/${ARTIFACT_NAME}.java
        cp DockerDemo.class artifacts/${ARTIFACT_NAME}.class
        cp Dockerfile artifacts/${ARTIFACT_NAME}.Dockerfile
        docker save $DOCKER_IMAGE_NAME:$GITHUB_RUN_NUMBER -o artifacts/${ARTIFACT_NAME}_image.tar

    - name: génération rapport de build
      run: |
        echo "=== rapport de build ===" > artifacts/${ARTIFACT_NAME}_report.txt
        echo "numéro d'exécution: $GITHUB_RUN_NUMBER" >> artifacts/${ARTIFACT_NAME}_report.txt
        echo "date de build: $(date)" >> artifacts/${ARTIFACT_NAME}_report.txt
        echo "image docker: $DOCKER_IMAGE_NAME:$GITHUB_RUN_NUMBER" >> artifacts/${ARTIFACT_NAME}_report.txt
        echo "commit git: $GITHUB_SHA" >> artifacts/${ARTIFACT_NAME}_report.txt
        echo "branche git: $GITHUB_REF_NAME" >> artifacts/${ARTIFACT_NAME}_report.txt
        echo "déclenché par: $GITHUB_ACTOR" >> artifacts/${ARTIFACT_NAME}_report.txt
        echo "dépôt: $GITHUB_REPOSITORY" >> artifacts/${ARTIFACT_NAME}_report.txt

    - name: téléversement des artifacts
      uses: actions/upload-artifact@v4
      with:
        name: A18_AdryanSerage_final_1288_build_${{ github.run_number }}
        path: artifacts/
        retention-days: 30

    - name: création marqueur de succès
      if: success()
      run: |
        echo "build $GITHUB_RUN_NUMBER réussi le $(date)" > artifacts/${ARTIFACT_NAME}_success.txt

    - name: téléversement marqueur de succès
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: A18_AdryanSerage_final_1288_success_marker
        path: artifacts/A18_AdryanSerage_final_1288_success.txt
        retention-days: 30

    - name: création release github
      if: success() && github.event_name == 'push'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        TAG_NAME="${ARTIFACT_NAME}_github_run_${{ github.run_number }}"
        RELEASE_TITLE="release ${ARTIFACT_NAME} - github run ${{ github.run_number }}"

        cat > release_notes.md << 'EOF'
        ## github actions run #${{ github.run_number }}

        **artifacts générés:**
        - A18_AdryanSerage_final_1288.java - code source java
        - A18_AdryanSerage_final_1288.class - bytecode compilé
        - A18_AdryanSerage_final_1288.Dockerfile - configuration docker
        - A18_AdryanSerage_final_1288_image.tar - image docker complète
        - A18_AdryanSerage_final_1288_report.txt - rapport de build
        - A18_AdryanSerage_final_1288_success.txt - marqueur de succès

        **image docker:** a18_adryanserrage_final_1288:${{ github.run_number }}
        **commit:** ${{ github.sha }}
        **branche:** ${{ github.ref_name }}
        **déclenché par:** ${{ github.actor }}

        build réussi avec succès via github actions.
        EOF

        gh release create "$TAG_NAME" \
          --title "$RELEASE_TITLE" \
          --notes-file release_notes.md \
          artifacts/${ARTIFACT_NAME}.java \
          artifacts/${ARTIFACT_NAME}.class \
          artifacts/${ARTIFACT_NAME}.Dockerfile \
          artifacts/${ARTIFACT_NAME}_image.tar \
          artifacts/${ARTIFACT_NAME}_report.txt \
          artifacts/${ARTIFACT_NAME}_success.txt

        echo "release github créée: $TAG_NAME"
