name: ci pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  ARTIFACT_NAME: A18_AdryanSerage_final_1288
  DOCKER_IMAGE_NAME: a18_adryanserrage_final_1288

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: récupération du code
      uses: actions/checkout@v4

    - name: configuration jdk 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    - name: compilation application java
      run: |
        javac DockerDemo.java
        echo "compilation terminée"

    - name: exécution application java
      run: |
        java DockerDemo

    - name: configuration docker buildx
      uses: docker/setup-buildx-action@v2

    - name: construction image docker
      run: |
        docker build -t $DOCKER_IMAGE_NAME:$GITHUB_RUN_NUMBER .
        docker build -t $DOCKER_IMAGE_NAME:latest .
        echo "image docker construite avec succès"

    - name: test image docker
      run: |
        docker run --rm $DOCKER_IMAGE_NAME:$GITHUB_RUN_NUMBER

    - name: préparation des artifacts
      run: |
        mkdir -p artifacts
        cp DockerDemo.java artifacts/${ARTIFACT_NAME}.java
        cp DockerDemo.class artifacts/${ARTIFACT_NAME}.class
        cp Dockerfile artifacts/${ARTIFACT_NAME}.Dockerfile
        docker save $DOCKER_IMAGE_NAME:$GITHUB_RUN_NUMBER -o artifacts/${ARTIFACT_NAME}_image.tar

    - name: génération rapport de build
      run: |
        echo "=== rapport de build ===" > artifacts/${ARTIFACT_NAME}_report.txt
        echo "numéro d'exécution: $GITHUB_RUN_NUMBER" >> artifacts/${ARTIFACT_NAME}_report.txt
        echo "date de build: $(date)" >> artifacts/${ARTIFACT_NAME}_report.txt
        echo "image docker: $DOCKER_IMAGE_NAME:$GITHUB_RUN_NUMBER" >> artifacts/${ARTIFACT_NAME}_report.txt
        echo "commit git: $GITHUB_SHA" >> artifacts/${ARTIFACT_NAME}_report.txt
        echo "branche git: $GITHUB_REF_NAME" >> artifacts/${ARTIFACT_NAME}_report.txt
        echo "déclenché par: $GITHUB_ACTOR" >> artifacts/${ARTIFACT_NAME}_report.txt
        echo "dépôt: $GITHUB_REPOSITORY" >> artifacts/${ARTIFACT_NAME}_report.txt

    - name: téléversement des artifacts
      uses: actions/upload-artifact@v4
      with:
        name: A18_AdryanSerage_final_1288_build_${{ github.run_number }}
        path: artifacts/
        retention-days: 30

    - name: création marqueur de succès
      if: success()
      run: |
        echo "build $GITHUB_RUN_NUMBER réussi le $(date)" > artifacts/${ARTIFACT_NAME}_success.txt

    - name: téléversement marqueur de succès
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: A18_AdryanSerage_final_1288_success_marker
        path: artifacts/A18_AdryanSerage_final_1288_success.txt
        retention-days: 30

    - name: création release github
      if: success() && github.event_name == 'push'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        TAG_NAME="${ARTIFACT_NAME}_github_run_${{ github.run_number }}"
        RELEASE_TITLE="release ${ARTIFACT_NAME} - github run ${{ github.run_number }}"

        cat > release_notes.md << 'EOF'
        ## github actions run #${{ github.run_number }}

        **artifacts générés:**
        - A18_AdryanSerage_final_1288.java - code source java
        - A18_AdryanSerage_final_1288.class - bytecode compilé
        - A18_AdryanSerage_final_1288.Dockerfile - configuration docker
        - A18_AdryanSerage_final_1288_image.tar - image docker complète
        - A18_AdryanSerage_final_1288_report.txt - rapport de build
        - A18_AdryanSerage_final_1288_success.txt - marqueur de succès

        **image docker:** a18_adryanserrage_final_1288:${{ github.run_number }}
        **commit:** ${{ github.sha }}
        **branche:** ${{ github.ref_name }}
        **déclenché par:** ${{ github.actor }}

        build réussi avec succès via github actions.
        EOF

        gh release create "$TAG_NAME" \
          --title "$RELEASE_TITLE" \
          --notes-file release_notes.md \
          artifacts/${ARTIFACT_NAME}.java \
          artifacts/${ARTIFACT_NAME}.class \
          artifacts/${ARTIFACT_NAME}.Dockerfile \
          artifacts/${ARTIFACT_NAME}_image.tar \
          artifacts/${ARTIFACT_NAME}_report.txt \
          artifacts/${ARTIFACT_NAME}_success.txt

        echo "release github créée: $TAG_NAME"

  verify-jenkins:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'

    steps:
    - name: attente démarrage build jenkins
      run: |
        echo "attente de 30 secondes pour que jenkins démarre le build..."
        sleep 30

    - name: vérification statut jenkins
      env:
        JENKINS_URL: ${{ secrets.JENKINS_URL }}
        JENKINS_USER: ${{ secrets.JENKINS_USER }}
        JENKINS_TOKEN: ${{ secrets.JENKINS_TOKEN }}
      run: |
        if [ -z "$JENKINS_URL" ]; then
          echo "⚠️ JENKINS_URL non configuré - skip de la vérification jenkins"
          echo "pour activer: ajouter JENKINS_URL, JENKINS_USER, JENKINS_TOKEN dans les secrets github"
          exit 0
        fi

        echo "vérification du statut du dernier build jenkins..."

        # récupérer le statut du dernier build
        RESPONSE=$(curl -s -u "${JENKINS_USER}:${JENKINS_TOKEN}" \
          "${JENKINS_URL}/job/A18_AdryanSerage_final_1288/lastBuild/api/json")

        BUILD_NUMBER=$(echo $RESPONSE | jq -r '.number')
        BUILD_RESULT=$(echo $RESPONSE | jq -r '.result')
        BUILD_URL=$(echo $RESPONSE | jq -r '.url')

        echo "build jenkins #${BUILD_NUMBER}"
        echo "résultat: ${BUILD_RESULT}"
        echo "url: ${BUILD_URL}"

        if [ "$BUILD_RESULT" = "SUCCESS" ]; then
          echo "✅ build jenkins réussi"
          exit 0
        elif [ "$BUILD_RESULT" = "null" ]; then
          echo "⏳ build jenkins en cours d'exécution..."
          echo "attente de 60 secondes supplémentaires..."
          sleep 60

          # deuxième vérification
          RESPONSE=$(curl -s -u "${JENKINS_USER}:${JENKINS_TOKEN}" \
            "${JENKINS_URL}/job/A18_AdryanSerage_final_1288/lastBuild/api/json")
          BUILD_RESULT=$(echo $RESPONSE | jq -r '.result')

          if [ "$BUILD_RESULT" = "SUCCESS" ]; then
            echo "✅ build jenkins réussi"
            exit 0
          elif [ "$BUILD_RESULT" = "null" ]; then
            echo "⚠️ build jenkins toujours en cours - vérifier manuellement"
            exit 0
          else
            echo "❌ build jenkins a échoué: ${BUILD_RESULT}"
            exit 1
          fi
        else
          echo "❌ build jenkins a échoué: ${BUILD_RESULT}"
          exit 1
        fi
